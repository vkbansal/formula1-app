---
import type { GetStaticPathsItem } from 'astro';
import MainLayout from 'layouts/MainLayout.astro';
import Breadcrumbs from 'components/Breadcrumbs.astro';
import type { ChartPoint, ChartData } from 'components/StandingsChart/common';
import { StandingsChart } from 'components/StandingsChart/StandingsChart';
import { loadData, type Season } from 'helpers/data';
import colors from 'helpers/colors';

export interface Props {
	season: Season;
	hasPrev: boolean;
	hasNext: boolean;
}

export async function getStaticPaths(): Promise<GetStaticPathsItem[]> {
	const seasons = await loadData('seasons');

	return seasons
		.sort((a, b) => a.year - b.year)
		.map((season) => {
			const hasPrev = seasons[0].year < season.year;
			const hasNext = seasons[seasons.length - 1].year > season.year;

			return {
				params: { year: season.year.toString() },
				props: { season, hasPrev, hasNext },
			};
		});
}

const {
	season: { year, rounds, constructors },
	hasNext,
	hasPrev,
} = Astro.props as Props;
// const metadata = await loadData('metadata');

const constructorsColors = constructors.reduce((p, c, i) => {
	p[`chart-color-${c.constructorRef}`] = colors[i];
	return p;
}, {} as Record<string, string>);

const constructorsChartData: ChartData[] = constructors.map((constructor_) => {
	const data = rounds.map((round): ChartPoint | null => {
		const result = round.constructorStandings.find(
			(c) => c.constructorRef === constructor_.constructorRef,
		);
		const podium = round.podium
			.filter((p) => p.constructorRef === constructor_.constructorRef)
			.map((p) => p.position);

		return result
			? {
					points: result.points,
					position: result.position,
					wins: result.wins,
					podium: podium,
			  }
			: null;
	});

	return {
		id: constructor_.constructorRef,
		label: constructor_.name,
		link: `/constructors/${constructor_.constructorRef}`,
		data,
	};
});

const lastRoundWithNoPodiums = rounds.findIndex((round) => round.podium.length === 0) - 1;
const lastCompletedRound = lastRoundWithNoPodiums > -1 ? lastRoundWithNoPodiums : rounds.length - 1;
const chartLabels = rounds.map((r) => r.name);
---

<MainLayout title={`Constructor Standings | ${year} Season`}>
	<div class="seasons-header">
		<Breadcrumbs
			links={[
				{ label: 'Seasons', href: '/seasons/' },
				{ label: `${year} Season`, href: `/seasons/${year}` },
				{ label: 'Constructor Standings', href: '' },
			]}
		/>
		<nav class="season-pagination">
			{hasPrev ? <a href={`/seasons/${year - 1}`}>&larr; {year - 1}</a> : null}
			{hasNext ? <a href={`/seasons/${year + 1}`}>{year + 1} &rarr;</a> : null}
		</nav>
	</div>
	<h1>
		Constructor Standings - {year} Season
	</h1>
	<div>
		<StandingsChart
			data={constructorsChartData}
			lastCompletedRound={lastCompletedRound}
			labels={chartLabels}
			legendLabel="Constructor"
			client:load
		/>
	</div>
	<br />
</MainLayout>

<style lang="scss" define:vars={{ ...constructorsColors }}></style>
